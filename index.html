<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JBV Investment Portal – Live Sync</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --card: #0b1220;
        --border: #1f2937;
      }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(180deg, var(--bg), #0b1220);
        color: var(--text);
      }
      header {
        padding: 20px; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
        background: rgba(255,255,255,0.02);
        backdrop-filter: blur(6px);
        position: sticky; top: 0; z-index: 10;
      }
      h1 { margin: 0; font-size: 18px; letter-spacing: 0.3px; }
      #status { font-size: 12px; color: var(--muted); }
      #status.ok { color: var(--ok); }
      #status.warn { color: var(--warn); }
      #status.err { color: var(--err); }

      main { max-width: 1100px; margin: 20px auto; padding: 0 16px 40px; }
      #controls { margin: 10px 0 20px; color: var(--muted); font-size: 13px; }

      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
      .card {
        background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        transition: border-color 120ms ease;
      }
      .card:hover { border-color: #334155; }
      .card h3 { margin: 0 0 8px; font-size: 16px; color: var(--accent); }
      .field { margin: 6px 0; }
      .field b { color: #cbd5e1; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); color: var(--muted); }
      .linked {
        margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border);
      }
      .linked h4 { margin: 6px 0; font-size: 13px; color: #cbd5e1; }
      .linked .item {
        padding: 8px; margin: 6px 0; border: 1px solid var(--border); border-radius: 8px; background: #0c1626;
      }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: var(--muted); }
    </style>
  </head>
  <body>
    <header>
      <h1>JBV Investment Portal – Partner Investments</h1>
      <div id="status" class="warn">Connecting…</div>
    </header>
    <main>
      <div id="controls" class="muted">
        Initial data loads from <code>GET /api/data</code>. Realtime updates arrive via <code>WebSocket</code>.
      </div>
      <div id="grid" class="grid"></div>
    </main>

    <script>
      const API_BASE = 'http://localhost:3000';
      const WS_URL = 'ws://localhost:3000';
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('grid');

      // Local in-memory index of records by Airtable record ID
      const state = new Map();

      function setStatus(text, cls) {
        statusEl.textContent = text;
        statusEl.className = cls || '';
      }

      // Safely format field values for display
      function formatValue(v) {
        if (v == null) return '';
        if (Array.isArray(v)) {
          // Array of primitives or objects
          if (v.length === 0) return '';
          const isPrimitive = v.every(x => (typeof x !== 'object' || x === null));
          if (isPrimitive) return v.join(', ');
          // If it's an array of attachment objects or linked record placeholders
          return v.map(x => typeof x === 'object' && x !== null ? (x.url || x.name || x.id || JSON.stringify(x)) : String(x)).join(', ');
        }
        if (typeof v === 'object') {
          // Show short JSON form
          try { return JSON.stringify(v); } catch { return String(v); }
        }
        return String(v);
      }

      function ensureCard(record) {
        const id = `rec_${record.id}`;
        let el = document.getElementById(id);
        if (!el) {
          el = document.createElement('div');
          el.className = 'card';
          el.id = id;
          gridEl.appendChild(el);
        }
        return el;
      }

      function renderRecord(record) {
        // Persist in local state
        state.set(record.id, record);

        const el = ensureCard(record);
        const f = record.fields || {};

        // Prefer a name-like field for title
        const title = f['Partner Investment'] || f['Name'] || f['Investment'] || record.id;
        const status = f['Status'] || f['Status (I)'] || '';
        const commitment = f['Commitment'] || '';
        const nav = f['Current NAV'] || f['Total NAV'] || '';

        // Linked sections
        const linked = record.linked || {};
        const linkedSections = [];
        for (const [key, items] of Object.entries(linked)) {
          if (!items || items.length === 0) continue;
          const inner = items.map((it) => {
            const lines = [];
            const fields = it.fields || {};
            const heading = fields['Name'] || fields['Title'] || it.id;
            lines.push(`<div class="muted"><b>${escapeHtml(heading)}</b></div>`);
            Object.entries(fields).forEach(([k, v]) => {
              if (k === 'Name' || k === 'Title') return; // already shown
              lines.push(`<div class="field"><b>${escapeHtml(k)}:</b> ${escapeHtml(formatValue(v))}</div>`);
            });
            return `<div class="item">${lines.join('')}</div>`;
          }).join('');
          linkedSections.push(`<div class="linked"><h4>${escapeHtml(key)}</h4>${inner}</div>`);
        }

        el.innerHTML = `
          <h3>${escapeHtml(title)}</h3>
          ${status ? `<div class="field"><span class="pill">${escapeHtml(status)}</span></div>` : ''}
          ${commitment ? `<div class="field"><b>Commitment:</b> ${escapeHtml(formatValue(commitment))}</div>` : ''}
          ${nav ? `<div class="field"><b>NAV:</b> ${escapeHtml(formatValue(nav))}</div>` : ''}

          <details style="margin-top:8px;">
            <summary class="muted">All Fields</summary>
            ${Object.entries(f).map(([k, v]) => `<div class="field"><b>${escapeHtml(k)}:</b> ${escapeHtml(formatValue(v))}</div>`).join('')}
          </details>

          ${linkedSections.join('')}
        `;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      async function loadInitial() {
        setStatus('Loading initial data…', 'warn');
        try {
          const res = await fetch(`${API_BASE}/api/data`);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'Failed');
          (json.data || []).forEach(renderRecord);
          setStatus(`Connected. Loaded ${json.count || (json.data || []).length} records.`, 'ok');
        } catch (err) {
          console.error('Initial load failed', err);
          setStatus('Initial load failed', 'err');
        }
      }

      function connectWS() {
        let ws;
        function open() {
          ws = new WebSocket(WS_URL);
          ws.addEventListener('open', () => setStatus('WebSocket connected', 'ok'));
          ws.addEventListener('close', () => {
            setStatus('WebSocket disconnected, retrying…', 'warn');
            setTimeout(() => open(), 1500);
          });
          ws.addEventListener('error', () => setStatus('WebSocket error', 'err'));
          ws.addEventListener('message', (ev) => {
            try {
              const msg = JSON.parse(ev.data);
              if (msg.type === 'record_update') {
                const arr = msg.records || [];
                arr.forEach(renderRecord);
              }
            } catch (e) {
              console.warn('Bad WS message', e);
            }
          });
        }
        open();
      }

      // Bootstrap
      loadInitial();
      connectWS();
    </script>
  </body>
  </html>

